---
title: "ISM Tut - Session 2 - Sampling"
author: "Niklas Haffert"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Goal of the Session
* Application of different sampling strategies
* Visualization of the effect of different sampling strategies

# Preparations
### Packages
* pacman for package management
```{r, message=FALSE}
suppressWarnings(if (!require("pacman"))
  install.packages("pacman", repos = "http://cran.r-project.org"))
```

* tidyverse: package for all tidy operations (dplyr, ggplot2, ...)
* urbnmapr: maps 
```{r, message=FALSE}
pacman::p_load(devtools, tidyverse)
devtools::install_github("UrbanInstitute/urbnmapr")
pacman::p_load(urbnmapr)
```

### Functions
Load functions stored in an external R-script 
```{r, message=FALSE}
source("../functions.R")
```

### Seed
Setting a seed allows to replicate random operations like sampling and get the same result
```{r set a seed}
set.seed(2020)
```

### Data
* "votes" holds the voting behavior of all voters in the US Presidential Election in 2016 [source](https://dataverse.harvard.edu/dataset.xhtml;jsessionid=1dd02598ea6d8fb7c74571ac4772?persistentId=doi%3A10.7910%2FDVN%2FVOQCHQ&version=&q=&fileTypeGroupFacet=%22Tabular+Data%22&fileAccess=&fileTag=&fileSortField=&fileSortOrder=)
* "maps_states" is a map of US-States
```{r data, message=FALSE}
votes <- readRDS("../SessionData/usa_2016/us_2016.rds")
map_states <- get_urbn_map("states", sf = TRUE) %>%
  rename(state = state_name)
```

Check out the data
```{r check data}
glimpse(votes)
```

Add information about turnout
```{r update data, message=FALSE}
votes <-
  votes %>%
  mutate(voter_id = 1:nrow(.),
         turnout = nrow(.)) %>%
  left_join(votes %>%
              group_by(state) %>%
              count(name = "turnout_state"))
```

Checking data again
```{r}
glimpse(votes)
```

### Sample Size
Determining the sample size
```{r sample size}
sample_size <- 1000
```

# Simple Random Sampling
### Sampling
Draw a sample of size 1000 without replacement (SRSWOR)
```{r drawing srs}
srs <-
  votes %>%
  sample_n(sample_size)
```

### Visualization
Visualize which states are represented in the sample
```{r map srs, message=FALSE}
map_states %>%
  left_join(srs %>%
              group_by(state) %>%
              count()) %>%
  mutate(sampled = ifelse(is.na(n), FALSE, TRUE)) %>%
  ggplot() +
  geom_sf(aes(fill = sampled)) +
  theme_map()
```

# Stratified Sampling
### Sampling
All states are included and within each state individuals are sampled (number based on the turnout in the state)
```{r drawing stratified sample}
str_sample <-
  votes %>%
  mutate(voters_strata = round(sample_size * turnout_state / turnout)) %>%
  group_by(state) %>%
  sample_n(voters_strata) %>%
  ungroup()
```

### Visualization
Visualization of how many individuals were sampled per state
```{r map stratified sample, message=FALSE}
map_states %>%
  left_join(str_sample %>%
              group_by(state) %>%
              count(name = "stratum_size")) %>%
  ggplot(aes(fill = stratum_size)) +
  geom_sf() +
  scale_fill_gradient(low = "white", high = "black") +
  theme_map()
```

# Cluster Sampling / Multi Stage Sampling

### Number of clusters
```{r number clusters}
number_clusters <- 5
```

### Sampling
Two sampling stages:
1. sampling five clusters (states)
```{r drawing cluster sample, message=FALSE}
states <- 
  votes %>%
  mutate(p_1 = turnout_state * number_clusters / nrow(.)) %>%
  group_by(state, p_1) %>%
  summarise() %>%
  ungroup() %>%
  sample_n(size = number_clusters, weight = p_1) %>% 
  pull(state)

states
```

2. within this clusters simple random sampling (sizes of the samples based on population size in the clusters)
```{r}
clusters <- 
  votes %>% 
  filter(state %in% states)

cl_sample <- 
  clusters %>% 
  group_by(state) %>% 
  sample_n(sample_size / number_clusters) %>% 
  ungroup()
```

### Visualization
Visualize which states are represented in the sample
```{r map cluster sample, message=FALSE}
map_states %>%
  left_join(cl_sample %>%
              group_by(state) %>%
              count()) %>%
  mutate(sampled = ifelse(is.na(n), FALSE, TRUE)) %>%
  ggplot() +
  geom_sf(aes(fill = sampled)) +
  theme_map()
```

# Save samples for further usage in the next session 
```{r save samples}
saveRDS(srs, "../SessionData/usa_2016/srs.rds")
saveRDS(str_sample, "../SessionData/usa_2016/str.rds")
saveRDS(cl_sample, "../SessionData/usa_2016/cl.rds")
```
